# SROS 现存的问题

## 未修复
### sros被独占时，通过HTTP的文件传输还是能进行。
原因：
由于HTTP和sros是两套分开的程序，当sros被独占时必须通知HTTP，但sros是通过session_id来标识独占者的，
所以需要做到这一点需要在所有HTTP请求中带上session_id参数，而且还有添加sros和HTTP的通信机制，sros、chip和matrix都需要大量改动。
考虑到下一个版本即将重构HTTP，所以此缺陷将在重构HTTP后修复


## 已修复

### 将一个名字很长的地图设置为当前地图的时候会导致chip登录失败
现象：
1. 登录的时候chip卡死，然后报未知错误。
2. chip-web能正常登录。
3. 直接启动start.up会打印如下：（journalctl是看不出来的）
```shell
[libprotobuf ERROR google/protobuf/wire_format_lite.cc:629] String field 'proto.SystemState.map_name' contains invalid UTF-8 data when serializing a protocol buffer. Use the 'bytes' type if you intend to send raw bytes.
```
4.当前地图显示乱码，导致无法加载当前地图，log如下：
```shell
Auto start location: map = 华能桂林燃气分布式能���V�, station_no = 0
```

原因：
1. sros中PoseSaver会每秒保存地图名到配置文件，但保存的文件名只有30个char，若文件名过长的时候就会被截断，
导致下次加载的时候只加载了一半，而且还无法转换成UTF-8，这就是为什么乱码的情况。
2. 由于protobuf只支持UTF-8，登录返回结果的那一帧数据中包含系统状态，所以导致chip无法解析protobuf，从而出现登录失败的情况。
3. chip-web能登录成功原因，应该和chip-web用的是第三方的protobuf库的原因有关。

规避方法： chip限制地图名不要太长

彻底解决方法：将30个char的地图名加长？？？

**已经彻底解决:** 在保存地图名前保存地图名的长度，然后地图名的长度不限。读取时先读取地图名的长度，再读取整个地图名。



---


### disable_action_task 和 disable_movement_task 的缺陷
现象：

当任务结束后，会发通知给对应的客户端，若客户端没有回复时，是不允许执行其他任务的。

这段时间内是由disable_action_task和disable_movement_task来标记的

当A用户执行完任务后，收到通知，但由于网络原因，没法将确认帧发给sros。在这段时间内，B用户检测到任务已经处于finished状态，于是发送新任务。
但B用于此时收到的回复是任务正在执行，无法开始新任务。

**已经彻底解决:** 在task中添加TASK_WAIT_FOR_FINISH状态，在等待ack过程中是处于TASK_WAIT_FOR_FINISH状态。